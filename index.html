<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Campaign Performance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Top Filters Section */
        .top-filters {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .refresh-section {
            display: flex;
            align-items: end;
            gap: 15px;
        }

        .refresh-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .sync-indicator.connected {
            background: #27ae60;
        }

        .sync-indicator.disconnected {
            background: #e74c3c;
        }

        .sync-indicator.loading {
            background: #f39c12;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Tab Styles */
        .tab-container {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-nav {
            display: flex;
            padding: 0 30px;
        }

        .tab-button {
            background: transparent;
            border: none;
            padding: 20px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            color: #2c3e50;
            background: rgba(52, 152, 219, 0.05);
        }

        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .setup-section {
            padding: 30px;
            background: #fff3cd;
            border-bottom: 1px solid #ffeaa7;
            display: none;
        }

        .setup-section.show {
            display: block;
        }

        .setup-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #856404;
            margin-bottom: 20px;
        }

        .setup-instructions {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }

        .setup-instructions h3 {
            color: #007bff;
            margin-bottom: 15px;
        }

        .setup-instructions ol {
            margin-left: 20px;
            line-height: 1.6;
        }

        .setup-instructions li {
            margin-bottom: 8px;
        }

        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 15px 0;
            border: 1px solid #e9ecef;
            overflow-x: auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: 600;
            color: #856404;
            font-size: 1rem;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #ffeaa7;
            border-radius: 6px;
            font-size: 1rem;
        }

        .connect-btn {
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .connect-btn:hover {
            background: #218838;
        }

        .connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .status-message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        .campaign-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            font-size: 0.8rem;
            table-layout: fixed;
        }

        .campaign-table th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.2;
            min-width: 80px;
        }

        .campaign-table td {
            padding: 8px 4px;
            border-bottom: 1px solid #f1f2f6;
            text-align: center;
            transition: background-color 0.3s ease;
            white-space: normal;
            word-wrap: break-word;
            font-size: 0.8rem;
            line-height: 1.2;
        }

        .campaign-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .campaign-table tbody tr:nth-child(even) {
            background-color: #fafbfc;
        }

        .month-cell {
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            min-width: 60px;
            word-wrap: break-word;
        }

        .week-cell {
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            min-width: 80px;
            word-wrap: break-word;
        }

        .currency {
            font-weight: 600;
            color: #27ae60;
            text-align: right;
            white-space: normal;
            word-wrap: break-word;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-archived {
            background: #d1ecf1;
            color: #0c5460;
        }

        .roas-positive {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
            border-radius: 4px;
            padding: 4px 8px;
        }

        .roas-negative {
            background: #f8d7da;
            color: #721c24;
            font-weight: 600;
            border-radius: 4px;
            padding: 4px 8px;
        }

        .campaign-row {
            border-left: 4px solid #3498db;
        }

        .settings-row {
            border-left: 4px solid #9b59b6;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .summary-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
            margin-bottom: 0;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .highlight {
            background: yellow;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .negative {
            color: #e74c3c !important;
        }

        .debug-info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-family: 'Segoe UI', sans-serif;
        }

        .insights-section {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .insights-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .insights-table th {
            padding: 12px;
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .insights-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        .insights-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .insights-table tbody tr:nth-child(even) {
            background-color: #fafbfc;
        }

        .insights-table .year-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .insights-table .currency-cell {
            text-align: right;
            font-weight: 600;
            color: #27ae60;
        }

        .insights-table .roas-cell {
            text-align: right;
            font-weight: 600;
        }

        .insights-table .roas-positive {
            color: #27ae60;
        }

        .insights-table .roas-negative {
            color: #e74c3c;
        }

        .total-row {
            border-top: 2px solid #3498db;
            font-weight: bold;
            background: #e8f4fd !important;
        }

        .charts-section {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        .full-width-chart {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .top-filters {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .filter-select {
                min-width: auto;
            }

            .campaign-table {
                font-size: 0.7rem;
            }

            .campaign-table th,
            .campaign-table td {
                padding: 6px 2px;
                font-size: 0.65rem;
            }
            
            .table-container {
                padding: 15px;
                overflow-x: auto;
            }

            .tab-nav {
                padding: 0 15px;
            }

            .tab-button {
                padding: 15px 20px;
                font-size: 1rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üìä Marketing Campaign Performance Dashboard</h1>
            <p>Real-time data from Google Sheets via Google Apps Script</p>
        </div>

        <div class="setup-section" id="setupSection">
            <div class="setup-title">üîß One-Time Setup Required</div>
            
            <div class="setup-instructions">
                <h3>üìã Quick Setup Instructions (5 minutes)</h3>
                <ol>
                    <li><strong>Open your Google Sheet</strong> with Meta/Leads/Opportunity/Settings data</li>
                    <li><strong>Go to Extensions ‚Üí Apps Script</strong></li>
                    <li><strong>Delete the default code</strong> and paste this code:</li>
                </ol>
                
                <div class="code-block">
function doGet() {
  try {
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    var metaSheet = spreadsheet.getSheetByName('Meta');
    var leadsSheet = spreadsheet.getSheetByName('Leads');
    var opportunitySheet = spreadsheet.getSheetByName('Opportunity');
    var settingsSheet = spreadsheet.getSheetByName('Settings');
    
    var response = {
      success: true,
      timestamp: new Date().toISOString(),
      data: {
        meta: metaSheet ? metaSheet.getDataRange().getValues() : [],
        leads: leadsSheet ? leadsSheet.getDataRange().getValues() : [],
        opportunity: opportunitySheet ? opportunitySheet.getDataRange().getValues() : [],
        settings: settingsSheet ? settingsSheet.getDataRange().getValues() : []
      }
    };
    
    return ContentService
      .createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    var errorResponse = {
      success: false,
      error: error.toString(),
      timestamp: new Date().toISOString()
    };
    
    return ContentService
      .createTextOutput(JSON.stringify(errorResponse))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
                </div>
                
                <ol start="4">
                    <li><strong>Save the project</strong> (Ctrl+S or File ‚Üí Save)</li>
                    <li><strong>Click Deploy ‚Üí New Deployment</strong></li>
                    <li><strong>Choose type:</strong> Web app</li>
                    <li><strong>Execute as:</strong> Me</li>
                    <li><strong>Who has access:</strong> Anyone</li>
                    <li><strong>Click Deploy</strong></li>
                    <li><strong>Copy the Web App URL</strong> (looks like: https://script.google.com/...)</li>
                    <li><strong>Paste it below and click Connect</strong></li>
                </ol>
            </div>
            
            <div class="form-group">
                <label for="webAppUrl">Google Apps Script Web App URL</label>
                <input type="text" id="webAppUrl" placeholder="Paste your Web App URL here" />
            </div>
            
            <button class="connect-btn" onclick="connectToAppsScript()">Connect to Dashboard</button>
            
            <div id="statusMessage"></div>
        </div>

        <div class="top-filters">
            <div class="filter-group">
                <label for="campaignFilter">Campaign Name</label>
                <select id="campaignFilter" class="filter-select">
                    <option value="">All Campaigns</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="statusFilter">Campaign Status</label>
                <select id="statusFilter" class="filter-select">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="archived">Archived</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="monthFilter">Month</label>
                <select id="monthFilter" class="filter-select">
                    <option value="">All Months</option>
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="yearFilter2">Year</label>
                <select id="yearFilter2" class="filter-select">
                    <option value="">All Years</option>
                    <option value="2025" selected>2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                </select>
            </div>

            <div class="refresh-section">
                <div class="sync-status">
                    <div class="sync-indicator loading" id="syncIndicator"></div>
                    <span id="syncStatus">Loading dashboard...</span>
                </div>
                
                <button class="refresh-btn" onclick="refreshData()" id="refreshBtn">
                    üîÑ Refresh Data
                </button>
                
                <button class="refresh-btn" onclick="showSettings()" id="settingsBtn" style="background: #6c757d;">
                    ‚öôÔ∏è Settings
                </button>
            </div>
        </div>

        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-button active" onclick="switchTab('sales')" id="salesTabButton">
                    üí∞ Sales per Campaign
                </button>
                <button class="tab-button" onclick="switchTab('settings')" id="settingsTabButton">
                    ‚öôÔ∏è Settings per Campaign
                </button>
                <button class="tab-button" onclick="switchTab('calculator')" id="calculatorTabButton">
                    üìä Campaign Ads Projection Calculator
                </button>
            </div>
        </div>

        <div class="tab-content active" id="salesTab">
            <div class="summary-metrics" id="summaryMetrics" style="display: none;">
                <div class="metric-card">
                    <div class="metric-value" id="totalCampaigns">0</div>
                    <div class="metric-label">Total Campaigns</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalAdSpent">AED 0</div>
                    <div class="metric-label">Total Ad Spent</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalLeads">0</div>
                    <div class="metric-label">Total Leads</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalUnitSold">0</div>
                    <div class="metric-label">Total Unit Sold</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalSalesVolume">AED 0</div>
                    <div class="metric-label">Total Sales Volume</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalRevenue">AED 0</div>
                    <div class="metric-label">Company Revenue (5.5%)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgROAS">0</div>
                    <div class="metric-label">Average ROAS</div>
                </div>
            </div>

            <div class="insights-section" id="insightsSection" style="display: none; background: #f8f9fa; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üìä Yearly ROAS Analysis & Recommendations</h3>
                
                <div class="insights-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="insights-table-container" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px; color: #2c3e50; text-align: center;">Yearly Performance Summary</h4>
                        <table class="insights-table" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white;">
                                    <th style="padding: 12px; text-align: left; border-radius: 6px 0 0 0;">Year</th>
                                    <th style="padding: 12px; text-align: right;">Ad Spend</th>
                                    <th style="padding: 12px; text-align: right;">Revenue</th>
                                    <th style="padding: 12px; text-align: right; border-radius: 0 6px 0 0;">ROAS (Yearly)</th>
                                </tr>
                            </thead>
                            <tbody id="yearlyInsightsTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                        <div style="margin-top: 15px; padding: 15px; background: #e8f4fd; border-radius: 6px; border-left: 4px solid #3498db;">
                            <strong style="color: #2c3e50;">Weighted ROAS:</strong>
                            <span id="weightedAvgROAS" style="color: #3498db; font-weight: bold; font-size: 1.1em;">0.00</span>
                        </div>
                    </div>
                    
                    <div class="insights-chart-container" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px; color: #2c3e50; text-align: center;">ROAS Trend by Year</h4>
                        <canvas id="yearlyROASChart" width="400" height="250"></canvas>
                    </div>
                </div>
            </div>

            <div class="charts-section" id="chartsSection" style="display: none;">
                <div class="charts-grid">
                    <div class="chart-container">
                        <h4>Monthly Ad Spend vs Revenue</h4>
                        <canvas id="spendRevenueChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>ROAS Trend</h4>
                        <canvas id="roasChart" width="400" height="200"></canvas>
                    </div>
                </div>
                <div class="chart-container full-width-chart">
                    <h4>Top Campaigns by Ad Spend</h4>
                    <canvas id="topCampaignsChart" width="800" height="300"></canvas>
                </div>
            </div>

            <div class="table-container">
                <div class="loading" id="loadingMessage">
                    <div class="loading-spinner"></div>
                    Loading your marketing dashboard...
                </div>
                <table class="campaign-table" id="campaignTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Ad Spent</th>
                            <th>Leads Generated</th>
                            <th>Cost Per Lead</th>
                            <th>Unit Sold</th>
                            <th>Avg Deal Size</th>
                            <th>Sales Volume</th>
                            <th>Company Revenue (5.5%)</th>
                            <th>ROAS</th>
                            <th>Avg Closing Time (Months)</th>
                            <th>Closer (20%)</th>
                            <th>Team Leader (4%)</th>
                            <th>Head of Sales (1%)</th>
                            <th>External Marketing</th>
                            <th>Net Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="campaignTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="settingsTab">
            <div class="summary-metrics" id="settingsSummaryMetrics">
                <div class="metric-card">
                    <div class="metric-value" id="totalSettingsLeads">0</div>
                    <div class="metric-label">Total Leads</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalSettingsSpent">AED 0</div>
                    <div class="metric-label">Total Ad Spent</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalSettings">0</div>
                    <div class="metric-label">Total Settings</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgCPL">AED 0</div>
                    <div class="metric-label">Average CPL</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgCPS">AED 0</div>
                    <div class="metric-label">Average CPS</div>
                </div>
            </div>

            <div class="table-container">
                <div class="loading" id="settingsLoadingMessage" style="display: none;">
                    <div class="loading-spinner"></div>
                    Loading settings data...
                </div>
                <table class="campaign-table" id="settingsTable">
                    <thead>
                        <tr>
                            <th>Campaign</th>
                            <th>Week No</th>
                            <th>Year</th>
                            <th>No. of Leads</th>
                            <th>Ads Spent</th>
                            <th>CPL</th>
                            <th>No. of Settings</th>
                            <th>CPS</th>
                        </tr>
                    </thead>
                    <tbody id="settingsTableBody">
                    </tbody>
                </table>
            </div>

            </div>

        <div class="tab-content" id="calculatorTab">
            <div class="calculator-container" style="padding: 30px; max-width: 1200px; margin: 0 auto;">
                <div class="calculator-header" style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #2c3e50; margin-bottom: 10px;">Campaign Ads Projection Calculator</h2>
                    <p style="color: #6c757d;">Enter your campaign parameters to calculate projections and ROI</p>
                </div>

                <div class="calculator-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div class="calculator-inputs" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">üìù Campaign Inputs</h3>
                        
                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Total Budget (AED)</label>
                            <input type="number" id="totalBudget" class="calc-input" value="10000" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Impressions</label>
                            <input type="number" id="impressions" class="calc-input" value="100000" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Click-Through Rate (%)</label>
                            <input type="number" id="ctr" class="calc-input" value="2.5" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Lead Conversion Rate (%)</label>
                            <input type="number" id="leadConversionRate" class="calc-input" value="15" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Booking Rate (%)</label>
                            <input type="number" id="bookingRate" class="calc-input" value="60" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Show Rate (%)</label>
                            <input type="number" id="showRate" class="calc-input" value="70" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Close Rate (%)</label>
                            <input type="number" id="closeRate" class="calc-input" value="25" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Average Deal Size (AED)</label>
                            <input type="number" id="avgDealSize" class="calc-input" value="500000" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Commission Rate (%)</label>
                            <input type="number" id="commissionRate" class="calc-input" value="5.5" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Collection Rate (%)</label>
                            <input type="number" id="collectionRate" class="calc-input" value="85" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Setter Commission Rate (%)</label>
                            <input type="number" id="setterCommissionRate" class="calc-input" value="20" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>

                        <div class="input-group" style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">Closer Commission Rate (%)</label>
                            <input type="number" id="closerCommissionRate" class="calc-input" value="35" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 16px;" onchange="calculateProjections()">
                        </div>
                    </div>

                    <div class="calculator-results" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #27ae60;">üìä Calculated Results</h3>
                        
                        <div class="result-grid" style="display: grid; gap: 15px;">
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3498db;">
                                <span style="font-weight: 600; color: #2c3e50;">Cost Per Click:</span>
                                <span id="costPerClick" style="font-weight: 600; color: #3498db;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3498db;">
                                <span style="font-weight: 600; color: #2c3e50;">Cost Per Lead:</span>
                                <span id="costPerLead" style="font-weight: 600; color: #3498db;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #e67e22;">
                                <span style="font-weight: 600; color: #2c3e50;">Total Leads:</span>
                                <span id="totalLeadsCalc" style="font-weight: 600; color: #e67e22;">0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #e67e22;">
                                <span style="font-weight: 600; color: #2c3e50;">Total Booked Calls:</span>
                                <span id="totalBookedCalls" style="font-weight: 600; color: #e67e22;">0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9b59b6;">
                                <span style="font-weight: 600; color: #2c3e50;">Cost Per Booked Call:</span>
                                <span id="costPerBookedCall" style="font-weight: 600; color: #9b59b6;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #9b59b6;">
                                <span style="font-weight: 600; color: #2c3e50;">Total Taken Calls:</span>
                                <span id="totalTakenCalls" style="font-weight: 600; color: #9b59b6;">0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #e74c3c;">
                                <span style="font-weight: 600; color: #2c3e50;">Cost Per Taken Sales Call:</span>
                                <span id="costPerTakenCall" style="font-weight: 600; color: #e74c3c;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #27ae60;">
                                <span style="font-weight: 600; color: #2c3e50;">Total Units Closed:</span>
                                <span id="totalUnitsClosed" style="font-weight: 600; color: #27ae60;">0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #27ae60;">
                                <span style="font-weight: 600; color: #2c3e50;">Total Revenue Contracted:</span>
                                <span id="totalRevenueContracted" style="font-weight: 600; color: #27ae60;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #27ae60;">
                                <span style="font-weight: 600; color: #2c3e50;">Total Revenue Per Close:</span>
                                <span id="totalRevenuePerClose" style="font-weight: 600; color: #27ae60;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #f39c12;">
                                <span style="font-weight: 600; color: #2c3e50;">Total Revenue Collected:</span>
                                <span id="totalRevenueCollected" style="font-weight: 600; color: #f39c12;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #34495e;">
                                <span style="font-weight: 600; color: #2c3e50;">Cost Per Acquisition:</span>
                                <span id="costPerAcquisition" style="font-weight: 600; color: #34495e;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #8e44ad;">
                                <span style="font-weight: 600; color: #2c3e50;">Revenue Return On Ad Spend:</span>
                                <span id="revenueROAS" style="font-weight: 600; color: #8e44ad;">0x</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #16a085;">
                                <span style="font-weight: 600; color: #2c3e50;">Setters Needed:</span>
                                <span id="settersNeeded" style="font-weight: 600; color: #16a085;">0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #16a085;">
                                <span style="font-weight: 600; color: #2c3e50;">Setter Commission:</span>
                                <span id="setterCommission" style="font-weight: 600; color: #16a085;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #c0392b;">
                                <span style="font-weight: 600; color: #2c3e50;">Closers Needed:</span>
                                <span id="closersNeeded" style="font-weight: 600; color: #c0392b;">0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #c0392b;">
                                <span style="font-weight: 600; color: #2c3e50;">Closer Commission:</span>
                                <span id="closerCommission" style="font-weight: 600; color: #c0392b;">AED 0</span>
                            </div>
                            <div class="result-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: linear-gradient(135deg, #27ae60, #2ecc71); border-radius: 8px; box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);">
                                <span style="font-weight: 700; color: white; font-size: 18px;">Net Profit:</span>
                                <span id="netProfit" style="font-weight: 700; color: white; font-size: 18px;">AED 0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calculator-chart" style="margin-top: 30px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h4 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">Revenue Funnel Visualization</h4>
                    <canvas id="calculatorFunnelChart" width="800" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
        let campaignData = [];
        let settingsData = [];
        let filteredData = [];
        let filteredSettingsData = [];
        let allCampaigns = [];
        let allMonths = [];
        let allWeeks = [];
        let isConnected = false;
        let webAppUrl = '';
        let currentTab = 'sales';

        // Your Google Apps Script URL
        const DEFAULT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby8whpVPCiCiKLXIlbE5-pKdHEF9x04zOAA4zv3Gf1wdQt9kIvnQV9PHcAXUERNkMyA/exec';

        // FIXED: Dubai timezone-aware week calculation (Sunday-Saturday weeks)
        function getWeekNumber(date) {
            try {
                // Handle both string dates and Date objects
                let d;
                if (typeof date === 'string') {
                    // Parse date string and handle Dubai timezone (+04:00)
                    d = new Date(date);
                } else {
                    d = new Date(date);
                }
                
                // Check if date is valid
                if (isNaN(d.getTime())) {
                    console.warn('Invalid date passed to getWeekNumber:', date);
                    return 1;
                }
                
                // Convert to Dubai time (UTC+4) if not already
                // Create a new date adjusted for Dubai timezone
                const dubaiDate = new Date(d.getTime());
                
                // Get year for this date in Dubai timezone
                const year = dubaiDate.getFullYear();
                
                // Get January 1st of this year
                const jan1 = new Date(year, 0, 1);
                
                // Calculate days since January 1st
                const daysSinceJan1 = Math.floor((dubaiDate - jan1) / (24 * 60 * 60 * 1000));
                
                // Get the day of the week for January 1st (0 = Sunday, 1 = Monday, etc.)
                const jan1DayOfWeek = jan1.getDay();
                
                // Calculate week number with Sunday as the first day of the week
                // Formula: (days since Jan 1 + day of week of Jan 1) / 7 + 1, rounded down
                const weekNumber = Math.floor((daysSinceJan1 + jan1DayOfWeek) / 7) + 1;
                
                // Ensure week number is within reasonable bounds
                const finalWeekNumber = Math.max(1, Math.min(53, weekNumber));
                
                return finalWeekNumber;
                
            } catch (error) {
                console.warn('Error in getWeekNumber:', error, 'Date:', date);
                return 1; // Return week 1 as fallback
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + 'TabButton').classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Apply appropriate filters or initialize calculator
            if (tabName === 'sales') {
                applyFilters();
            } else if (tabName === 'settings') {
                applySettingsFilters();
            } else if (tabName === 'calculator') {
                calculateProjections();
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        function updateSyncStatus(status, connected) {
            const indicator = document.getElementById('syncIndicator');
            const statusText = document.getElementById('syncStatus');
            
            indicator.className = `sync-indicator ${connected ? 'connected' : (status.includes('Loading') ? 'loading' : 'disconnected')}`;
            statusText.textContent = status;
        }

        async function fetchDataFromAppsScript(url) {
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Unknown error from Apps Script');
            }
            
            return data.data;
        }

        // FIXED: Improved settings data processing with Dubai timezone and Sunday-Saturday weeks
        function processSettingsData(settingsSheetData, leadsSheetData, metaSheetData) {
            console.log('üîß PROCESSING SETTINGS DATA (Fixed - Dubai timezone, Sunday-Saturday weeks)...');
            
            const debugInfo = [];
            
            if (!settingsSheetData || settingsSheetData.length === 0) {
                debugInfo.push('‚ùå No Settings sheet data available');
                updateDebugInfo(debugInfo);
                return [];
            }

            if (!leadsSheetData || leadsSheetData.length === 0) {
                debugInfo.push('‚ùå No Leads sheet data available');
                updateDebugInfo(debugInfo);
                return [];
            }

            if (!metaSheetData || metaSheetData.length === 0) {
                debugInfo.push('‚ùå No Meta sheet data available');
                updateDebugInfo(debugInfo);
                return [];
            }

            const settingsHeaders = settingsSheetData[0];
            const settingsRows = settingsSheetData.slice(1);
            
            const leadsHeaders = leadsSheetData[0];
            const leadsRows = leadsSheetData.slice(1);

            const metaHeaders = metaSheetData[0];
            const metaRows = metaSheetData.slice(1);

            // Find column indices
            const findColumnIndex = (headers, keywords) => {
                return headers.findIndex(h => {
                    if (!h || typeof h !== 'string') return false;
                    const headerLower = h.toLowerCase().trim();
                    return keywords.some(keyword => headerLower.includes(keyword.toLowerCase()));
                });
            };

            const settingsLeadIdIndex = findColumnIndex(settingsHeaders, ['lead_id']);
            const settingsDateIndex = findColumnIndex(settingsHeaders, ['date']);

            const leadsIdIndex = findColumnIndex(leadsHeaders, ['id']);
            const leadsUtmIndex = findColumnIndex(leadsHeaders, ['utm_campaign', 'campaign']);
            const leadsDateIndex = findColumnIndex(leadsHeaders, ['date_created']); // FIXED: Use date_created instead of date

            const metaCampaignIndex = findColumnIndex(metaHeaders, ['campaign name', 'campaign']);
            const metaSpentIndex = findColumnIndex(metaHeaders, ['amount spent', 'spent']);
            const metaDateIndex = findColumnIndex(metaHeaders, ['reporting starts', 'reporting', 'date']);
            const metaStatusIndex = findColumnIndex(metaHeaders, ['campaign delivery', 'delivery', 'status']);

            debugInfo.push(`üìç Column indices found:`);
            debugInfo.push(`    Settings: lead_id=${settingsLeadIdIndex}, date=${settingsDateIndex}`);
            debugInfo.push(`    Leads: id=${leadsIdIndex}, utm_campaign=${leadsUtmIndex}, date_created=${leadsDateIndex}`);
            debugInfo.push(`    Meta: campaign=${metaCampaignIndex}, spent=${metaSpentIndex}, date=${metaDateIndex}, status=${metaStatusIndex}`);

            if (settingsLeadIdIndex === -1 || settingsDateIndex === -1 || leadsIdIndex === -1 || 
                leadsUtmIndex === -1 || leadsDateIndex === -1 || metaCampaignIndex === -1 || 
                metaSpentIndex === -1 || metaDateIndex === -1) {
                debugInfo.push('‚ùå Required columns not found');
                updateDebugInfo(debugInfo);
                return [];
            }

            debugInfo.push(`‚úÖ Processing ${leadsRows.length} leads, ${settingsRows.length} settings, ${metaRows.length} Meta records`);

            // STEP 1: Create lead mapping (lead_id ‚Üí utm_campaign, date, and week) with proper date parsing
            const leadMapping = {};
            let leadDateParseErrors = 0;
            
            leadsRows.forEach(row => {
                const leadId = row[leadsIdIndex];
                const utmCampaign = row[leadsUtmIndex];
                const leadDate = row[leadsDateIndex];
                
                if (leadId && utmCampaign && leadDate) {
                    try {
                        // Handle various date formats including timestamps
                        let dateObj;
                        if (typeof leadDate === 'string') {
                            // Handle ISO date strings with timezone info
                            if (leadDate.includes('T') || leadDate.includes('+')) {
                                dateObj = new Date(leadDate);
                            } else {
                                // Handle simple date strings
                                dateObj = new Date(leadDate);
                            }
                        } else if (leadDate instanceof Date) {
                            dateObj = leadDate;
                        } else {
                            // Handle Excel date numbers
                            dateObj = new Date(leadDate);
                        }
                        
                        if (isNaN(dateObj.getTime())) {
                            throw new Error('Invalid date');
                        }
                        
                        const year = dateObj.getFullYear();
                        const week = getWeekNumber(dateObj);
                        
                        leadMapping[leadId] = {
                            utmCampaign: utmCampaign,
                            leadDate: leadDate,
                            year: year,
                            week: week,
                            dateObj: dateObj
                        };
                        
                    } catch (e) {
                        leadDateParseErrors++;
                        if (leadDateParseErrors <= 5) { // Only log first 5 errors to avoid spam
                            console.warn('Could not parse lead date:', leadDate, 'for lead:', leadId, 'Error:', e.message);
                        }
                    }
                }
            });

            debugInfo.push(`üìä Lead mapping created: ${Object.keys(leadMapping).length} leads (${leadDateParseErrors} date parse errors)`);

            // STEP 2: Group Meta spending by campaign and week with proper date parsing
            const metaSpendingByWeek = {};
            let metaDateParseErrors = 0;
            
            metaRows.forEach(row => {
                const campaignName = row[metaCampaignIndex];
                const reportingDate = row[metaDateIndex];
                const spent = parseFloat(row[metaSpentIndex]) || 0;
                const status = row[metaStatusIndex];
                
                if (!campaignName || !reportingDate || spent === 0) return;
                
                try {
                    // Handle various date formats
                    let dateObj;
                    if (typeof reportingDate === 'string') {
                        if (reportingDate.includes('T') || reportingDate.includes('+')) {
                            dateObj = new Date(reportingDate);
                        } else {
                            dateObj = new Date(reportingDate);
                        }
                    } else if (reportingDate instanceof Date) {
                        dateObj = reportingDate;
                    } else {
                        dateObj = new Date(reportingDate);
                    }
                    
                    if (isNaN(dateObj.getTime())) {
                        throw new Error('Invalid date');
                    }
                    
                    const year = dateObj.getFullYear();
                    const week = getWeekNumber(dateObj);
                    
                    const key = `${campaignName}-${year}-${week}`;
                    
                    if (!metaSpendingByWeek[key]) {
                        metaSpendingByWeek[key] = {
                            campaignName,
                            year,
                            week,
                            totalSpent: 0,
                            status
                        };
                    }
                    
                    metaSpendingByWeek[key].totalSpent += spent;
                    metaSpendingByWeek[key].status = status;
                    
                } catch (e) {
                    metaDateParseErrors++;
                    if (metaDateParseErrors <= 5) {
                        console.warn('Could not parse Meta date:', reportingDate, 'Error:', e.message);
                    }
                }
            });

            debugInfo.push(`üí∞ Meta spending grouped: ${Object.keys(metaSpendingByWeek).length} campaign-weeks (${metaDateParseErrors} date parse errors)`);

            // STEP 3: Improved campaign matching function
            function campaignsMatch(utmCampaign, metaCampaign) {
                if (!utmCampaign || !metaCampaign) return false;
                
                const utmLower = utmCampaign.toLowerCase().trim();
                const metaLower = metaCampaign.toLowerCase().trim();
                
                // Exact match
                if (utmLower === metaLower) return true;
                
                // Remove common prefixes/suffixes and special characters for better matching
                const cleanString = (str) => str.replace(/^(kl|ht)[\s_\-\/]*|[\s_\-\/]*copy$|[\s_\-\/]*new$|[\s_\-\/]*\d{4}$|[^\w\s]/gi, '').trim();
                
                const utmClean = cleanString(utmLower);
                const metaClean = cleanString(metaLower);
                
                // Check if one contains the other after cleaning
                if (utmClean && metaClean && (utmClean.includes(metaClean) || metaClean.includes(utmClean))) {
                    return true;
                }
                
                // Check for significant word overlap (at least 60% of words match)
                const utmWords = utmClean.split(/\s+/).filter(w => w.length > 2);
                const metaWords = metaClean.split(/\s+/).filter(w => w.length > 2);
                
                if (utmWords.length === 0 || metaWords.length === 0) return false;
                
                let matchingWords = 0;
                for (const utmWord of utmWords) {
                    for (const metaWord of metaWords) {
                        if (utmWord === metaWord || utmWord.includes(metaWord) || metaWord.includes(utmWord)) {
                            matchingWords++;
                            break;
                        }
                    }
                }
                
                const matchRatio = matchingWords / Math.max(utmWords.length, metaWords.length);
                return matchRatio >= 0.6; // At least 60% word match
            }

            // STEP 4: Count leads directly from Leads sheet by week
            const processedData = [];
            let totalW34Leads = 0; // Special tracking for W34 debugging
            
            Object.keys(metaSpendingByWeek).forEach(metaKey => {
                const metaData = metaSpendingByWeek[metaKey];
                const { campaignName, year, week } = metaData;
                
                // Count leads for this Meta campaign-week directly from Leads sheet
                let totalLeads = 0;
                const uniqueLeadIds = new Set();
                
                Object.keys(leadMapping).forEach(leadId => {
                    const leadInfo = leadMapping[leadId];
                    
                    // Check if lead belongs to this Meta campaign-week
                    if (leadInfo.year === year && leadInfo.week === week && 
                        campaignsMatch(leadInfo.utmCampaign, campaignName)) {
                        uniqueLeadIds.add(leadId);
                        
                        // Track W34 for debugging
                        if (week === 34 && year === 2025) {
                            totalW34Leads++;
                        }
                    }
                });
                
                totalLeads = uniqueLeadIds.size;
                
                // Count settings (leads that actually had settings appointments)
                const uniqueSettings = new Set();
                settingsRows.forEach(settingRow => {
                    const settingLeadId = settingRow[settingsLeadIdIndex];
                    const settingDate = settingRow[settingsDateIndex];
                    
                    if (settingLeadId && uniqueLeadIds.has(settingLeadId) && settingDate) {
                        try {
                            // Settings can be in any week, but attribute to original lead week
                            uniqueSettings.add(settingLeadId);
                        } catch (e) {
                            console.warn('Could not parse setting date:', settingDate);
                        }
                    }
                });
                
                const totalSettings = uniqueSettings.size;
                const cpl = totalLeads > 0 ? (metaData.totalSpent / totalLeads) : 0;
                const cps = totalSettings > 0 ? (metaData.totalSpent / totalSettings) : 0;
                
                if (totalLeads > 0 || metaData.totalSpent > 0) { // Only include if there are leads or spend
                    processedData.push({
                        campaignName: campaignName,
                        weekNo: `W${week}`,
                        year: year,
                        week: week,
                        status: metaData.status,
                        noOfLeads: totalLeads,
                        adsSpent: metaData.totalSpent,
                        cpl: cpl,
                        noOfSettings: totalSettings,
                        cps: cps
                    });
                }
            });

            // Debug summary
            debugInfo.push(`üìä FINAL PROCESSING SUMMARY:`);
            debugInfo.push(`    Total entries created: ${processedData.length}`);
            debugInfo.push(`    Week calculation: Sunday-Saturday (Dubai timezone)`);
            
            const totalProcessedLeads = processedData.reduce((sum, entry) => sum + entry.noOfLeads, 0);
            const totalProcessedSettings = processedData.reduce((sum, entry) => sum + entry.noOfSettings, 0);
            const w34Entry = processedData.find(entry => entry.weekNo === 'W34' && entry.year === 2025);
            
            debugInfo.push(`    Total leads attributed: ${totalProcessedLeads}`);
            debugInfo.push(`    Total settings attributed: ${totalProcessedSettings}`);
            debugInfo.push(`    W34 2025 total leads found: ${totalW34Leads}`);
            if (w34Entry) {
                debugInfo.push(`    W34 2025 All Campaigns display: ${w34Entry.noOfLeads} leads, ${w34Entry.noOfSettings} settings`);
            }

            // Sort by campaign, year, week
            processedData.sort((a, b) => {
                if (a.campaignName !== b.campaignName) {
                    return a.campaignName.localeCompare(b.campaignName);
                }
                if (a.year !== b.year) {
                    return b.year - a.year;
                }
                return b.week - a.week;
            });

            updateDebugInfo(debugInfo);
            return processedData;
        }

        function updateDebugInfo(debugInfo) {
            const debugElement = document.getElementById('debugContent');
            if (debugElement) {
                debugElement.innerHTML = debugInfo.map(line => `<div>${line}</div>`).join('');
            }
            
            // Auto-show debug if there are errors or important info
            const hasErrors = debugInfo.some(line => line.includes('‚ùå'));
            const debugContainer = document.getElementById('settingsDebugInfo');
            if (debugContainer && (hasErrors || debugInfo.length > 10)) {
                debugContainer.style.display = 'block';
            }
        }

        async function connectToAppsScript() {
            const url = document.getElementById('webAppUrl').value.trim();

            if (!url) {
                showStatus('Please paste your Google Apps Script Web App URL', 'error');
                return;
            }

            if (!url.includes('script.google.com')) {
                showStatus('Please enter a valid Google Apps Script URL', 'error');
                return;
            }

            webAppUrl = url;
            const connectBtn = document.querySelector('.connect-btn');
            connectBtn.textContent = 'Connecting...';
            connectBtn.disabled = true;
            updateSyncStatus('Connecting to Google Apps Script...', false);

            try {
                showStatus('Fetching data from Google Sheets...', 'success');
                const sheetsData = await fetchDataFromAppsScript(url);
                
                updateSyncStatus('Processing campaign data...', false);
                processSheetData(sheetsData);
                
                // Process settings data with Meta sheet for ad spend
                updateSyncStatus('Processing settings data...', false);
                settingsData = processSettingsData(sheetsData.settings, sheetsData.leads, sheetsData.meta);
                
                isConnected = true;
                
                // Hide setup section
                document.getElementById('setupSection').classList.remove('show');
                
                // Show tables and metrics
                document.getElementById('campaignTable').style.display = 'table';
                document.getElementById('summaryMetrics').style.display = 'grid';
                document.getElementById('insightsSection').style.display = 'block';
                document.getElementById('settingsSummaryMetrics').style.display = 'grid';
                document.getElementById('loadingMessage').style.display = 'none';
                
                updateSyncStatus('‚úÖ Dashboard ready', true);
                showStatus(`‚úÖ Success! Dashboard connected and data loaded`, 'success');
                
                populateFilters();
                populateSettingsFilters();
                applyFilters();
                applySettingsFilters();
                
                // Save URL
                localStorage.setItem('webAppUrl', url);
                
                // Enable auto-refresh
                startAutoRefresh();
                
            } catch (error) {
                showStatus(`Connection failed: ${error.message}`, 'error');
                updateSyncStatus('‚ùå Connection failed', false);
                console.error('Connection error:', error);
            }

            connectBtn.textContent = 'Connect to Dashboard';
            connectBtn.disabled = false;
        }

        function processSheetData(sheetsData) {
            const metaData = sheetsData.meta;
            const leadsData = sheetsData.leads;
            const opportunityData = sheetsData.opportunity;
            
            console.log('Raw data received:', {
                meta: metaData.length,
                leads: leadsData.length,
                opportunities: opportunityData.length
            });

            // Process headers and data (first row is headers)
            const metaHeaders = metaData[0];
            const metaRows = metaData.slice(1);
            
            const leadsHeaders = leadsData[0];
            const leadsRows = leadsData.slice(1);
            
            const opportunityHeaders = opportunityData[0];
            const opportunityRows = opportunityData.slice(1);

            // Find column indices for Meta sheet
            const metaCampaignIndex = metaHeaders.findIndex(h => 
                h && (h.toLowerCase().includes('campaign name') || h.toLowerCase().includes('campaign'))
            );
            const metaSpentIndex = metaHeaders.findIndex(h => 
                h && (h.toLowerCase().includes('amount spent') || h.toLowerCase().includes('spent'))
            );
            const metaStatusIndex = metaHeaders.findIndex(h => 
                h && (h.toLowerCase().includes('delivery') || h.toLowerCase().includes('status'))
            );
            const metaDateIndex = metaHeaders.findIndex(h => 
                h && (h.toLowerCase().includes('reporting') || h.toLowerCase().includes('date'))
            );

            // Find column indices for Leads sheet
            const leadsUtmIndex = leadsHeaders.findIndex(h => 
                h && h.toLowerCase().includes('utm_campaign')
            );
            const leadsIdIndex = leadsHeaders.findIndex(h => 
                h && h.toLowerCase() === 'id'
            );
            const leadsDateIndex = leadsHeaders.findIndex(h => 
                h && h.toLowerCase() === 'date_created' // FIXED: Use date_created instead of date
            );

            // Find column indices for Opportunity sheet
            const oppValueIndex = opportunityHeaders.findIndex(h => 
                h && h.toLowerCase().includes('value')
            );
            const oppStatusIndex = opportunityHeaders.findIndex(h => 
                h && h.toLowerCase().includes('status_label')
            );
            const oppLeadIdIndex = opportunityHeaders.findIndex(h => 
                h && h.toLowerCase().includes('lead_id')
            );
            const oppDateIndex = opportunityHeaders.findIndex(h => 
                h && h.toLowerCase().includes('date_won')
            );
            const oppUserNameIndex = opportunityHeaders.findIndex(h => 
                h && h.toLowerCase().includes('user_name')
            );
            
            console.log('Column indices found:', {
                meta: { campaign: metaCampaignIndex, spent: metaSpentIndex, status: metaStatusIndex, date: metaDateIndex },
                leads: { utm: leadsUtmIndex, id: leadsIdIndex, date: leadsDateIndex },
                opportunity: { value: oppValueIndex, status: oppStatusIndex, leadId: oppLeadIdIndex, date: oppDateIndex, userName: oppUserNameIndex }
            });

            // Group data by campaign and month for easier processing
            const campaignMonthData = {};
            
            // Process Meta data
            metaRows.forEach(row => {
                const campaignName = row[metaCampaignIndex];
                const reportingDate = row[metaDateIndex];
                const spent = parseFloat(row[metaSpentIndex]) || 0;
                const status = row[metaStatusIndex];
                
                if (!campaignName || !reportingDate) return;
                
                // Extract year-month from date
                let monthKey;
                try {
                    const date = new Date(reportingDate);
                    monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                } catch (e) {
                    console.warn('Could not parse date:', reportingDate);
                    return;
                }
                
                if (!campaignMonthData[campaignName]) {
                    campaignMonthData[campaignName] = {};
                }
                
                if (!campaignMonthData[campaignName][monthKey]) {
                    campaignMonthData[campaignName][monthKey] = {
                        campaignName: campaignName,
                        monthKey: monthKey,
                        totalSpent: 0,
                        status: status,
                        leads: [],
                        conversions: []
                    };
                }
                
                campaignMonthData[campaignName][monthKey].totalSpent += spent;
                campaignMonthData[campaignName][monthKey].status = status;
            });

            // Add leads data with date tracking for closing time calculation
            const leadDates = {}; // Store lead ID -> Date mapping for closing time calculation
            const leadToCampaign = {}; // Store lead ID -> campaign mapping for better lookup
            
            console.log('Processing leads data for campaign attribution...');
            
            leadsRows.forEach(row => {
                const utmCampaign = row[leadsUtmIndex] || '';
                const leadId = row[leadsIdIndex];
                const leadDate = row[leadsDateIndex];
                
                if (!utmCampaign || !leadId || !leadDate) return;
                
                // Store lead date for closing time calculation
                leadDates[leadId] = leadDate;
                
                // Find matching campaign - improved matching logic
                const matchingCampaign = Object.keys(campaignMonthData).find(campaignName => {
                    const utmLower = utmCampaign.toLowerCase().trim();
                    const campaignLower = campaignName.toLowerCase().trim();
                    
                    // Try exact match first
                    if (utmLower === campaignLower) return true;
                    
                    // Try partial matches
                    if (utmLower.includes(campaignLower) || campaignLower.includes(utmLower)) return true;
                    
                    // Try removing special characters and spaces for better matching
                    const utmCleaned = utmLower.replace(/[^a-z0-9]/g, '');
                    const campaignCleaned = campaignLower.replace(/[^a-z0-9]/g, '');
                    if (utmCleaned.includes(campaignCleaned) || campaignCleaned.includes(utmCleaned)) return true;
                    
                    return false;
                });
                
                if (!matchingCampaign) {
                    console.warn('No matching campaign found for UTM:', utmCampaign, 'Available campaigns:', Object.keys(campaignMonthData));
                    return;
                }
                
                // Store lead to campaign mapping
                leadToCampaign[leadId] = matchingCampaign;
                
                // Extract year-month from lead date
                let monthKey;
                try {
                    const date = new Date(leadDate);
                    monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                } catch (e) {
                    console.warn('Could not parse lead date:', leadDate, 'for lead:', leadId);
                    return;
                }
                
                if (campaignMonthData[matchingCampaign][monthKey]) {
                    campaignMonthData[matchingCampaign][monthKey].leads.push(leadId);
                    console.log(`‚úÖ Lead attributed: ${leadId} to ${matchingCampaign} ${monthKey}`);
                } else {
                    console.warn('No campaign month data found for:', matchingCampaign, monthKey);
                }
            });

            // Add opportunity data - only process "Closed Property" opportunities
            // Attribution based on LEAD DATE, calculate actual closing time
            console.log('Processing opportunities for sales volume attribution...');
            
            opportunityRows.forEach(row => {
                const leadId = row[oppLeadIdIndex];
                const value = parseFloat(row[oppValueIndex]) || 0;
                const status = row[oppStatusIndex];
                const wonDate = row[oppDateIndex];
                const userName = row[oppUserNameIndex] || '';
                
                // Only process "Closed Property" opportunities
                if (status !== 'Closed Property' || !leadId || !value || !wonDate) {
                    if (status === 'Closed Property' && !leadId) {
                        console.warn('Closed Property opportunity missing lead_id:', row);
                    }
                    return;
                }
                
                // Check if we have this lead ID in our leads data
                if (!leadDates[leadId]) {
                    console.warn('Lead ID not found in leads data:', leadId, 'Value:', value);
                    return;
                }
                
                // Calculate closing time in days
                let closingTimeDays = 0;
                try {
                    const leadDate = new Date(leadDates[leadId]);
                    const wonDateTime = new Date(wonDate);
                    closingTimeDays = Math.round((wonDateTime - leadDate) / (1000 * 60 * 60 * 24));
                } catch (e) {
                    console.warn('Could not calculate closing time for lead:', leadId);
                }
                
                // Find which campaign this lead belongs to
                let saleAttributed = false;
                for (const campaignName of Object.keys(campaignMonthData)) {
                    for (const monthKey of Object.keys(campaignMonthData[campaignName])) {
                        if (campaignMonthData[campaignName][monthKey].leads.includes(leadId)) {
                            // Attribute the sale to the LEAD DATE month, not won date
                            campaignMonthData[campaignName][monthKey].conversions.push({
                                leadId: leadId,
                                value: value,
                                closingTimeDays: closingTimeDays,
                                userName: userName
                            });
                            console.log(`‚úÖ Sale attributed: ${value} to ${campaignName} ${monthKey} (Lead: ${leadId}, User: ${userName})`);
                            saleAttributed = true;
                            break;
                        }
                    }
                    if (saleAttributed) break;
                }
                
                if (!saleAttributed) {
                    console.warn('‚ùå Could not attribute sale to any campaign:', {
                        leadId: leadId,
                        value: value,
                        leadDate: leadDates[leadId],
                        userName: userName
                    });
                }
            });

            // Convert to final campaign data structure
            campaignData = [];
            
            // Get all unique campaigns for filtering
            allCampaigns = Object.keys(campaignMonthData);
            
            // Create monthly entries for each campaign
            Object.keys(campaignMonthData).forEach(campaignName => {
                Object.keys(campaignMonthData[campaignName]).forEach(monthKey => {
                    const monthData = campaignMonthData[campaignName][monthKey];
                    
                    const uniqueLeads = [...new Set(monthData.leads)].length;
                    const totalUnitSold = monthData.conversions.length;
                    const salesVolume = monthData.conversions.reduce((sum, conv) => sum + conv.value, 0); // Total sales value
                    const companyRevenue = salesVolume * 0.055; // Company gets 5.5% commission
                    const totalSpent = monthData.totalSpent;
                    
                    const costPerLead = uniqueLeads > 0 ? (totalSpent / uniqueLeads) : 0;
                    const conversionRate = uniqueLeads > 0 ? (totalUnitSold / uniqueLeads * 100) : 0;
                    const roas = totalSpent > 0 ? (companyRevenue / totalSpent) : 0; // ROAS based on company revenue, not sales volume
                    const avgDealSize = totalUnitSold > 0 ? (salesVolume / totalUnitSold) : 0;
                    
                    // Calculate ACTUAL average closing time in months from conversions
                    const avgClosingTimeDays = totalUnitSold > 0 ? 
                        (monthData.conversions.reduce((sum, conv) => sum + (conv.closingTimeDays || 0), 0) / totalUnitSold) : 0;
                    const avgClosingTimeMonths = avgClosingTimeDays / 30.44; // Convert days to months (average month = 30.44 days)

                    // Calculate commission breakdown based on company revenue
                    const closerCommission = companyRevenue * 0.20; // 20% of company revenue
                    const headOfSalesCommission = companyRevenue * 0.01; // 1% of company revenue
                    const externalMarketingTeam = 79000; // Fixed monthly amount
                    
                    // Team Leader commission calculation (4% but exclude Felix Heindoerfer)
                    let teamLeaderCommission = 0;
                    const hasFelixDeals = monthData.conversions.some(conv => 
                        conv.userName && conv.userName.toLowerCase().includes('felix heindoerfer')
                    );
                    
                    if (totalUnitSold > 0 && !hasFelixDeals) {
                        // Only calculate team leader commission if Felix is not the closer
                        teamLeaderCommission = companyRevenue * 0.04; // 4% of company revenue
                    } else if (totalUnitSold > 0 && hasFelixDeals) {
                        // Calculate proportionally - only for non-Felix deals
                        const nonFelixRevenue = monthData.conversions
                            .filter(conv => !conv.userName || !conv.userName.toLowerCase().includes('felix heindoerfer'))
                            .reduce((sum, conv) => sum + (conv.value * 0.055), 0); // Company revenue from non-Felix deals
                        teamLeaderCommission = nonFelixRevenue * 0.04;
                    }

                    // Format month display and create month name for filtering
                    const [year, month] = monthKey.split('-');
                    const monthDisplay = new Date(year, month - 1, 1).toLocaleDateString('en-GB', { 
                        year: '2-digit', 
                        month: 'short' 
                    });
                    
                    // Create full month name for filtering
                    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'];
                    const fullMonthName = monthNames[parseInt(month) - 1];

                    campaignData.push({
                        campaignName: campaignName, // Store original campaign name for filtering
                        month: monthDisplay, // Display as "Jan-24", "Feb-24", etc.
                        monthKey: monthKey,
                        fullMonthName: fullMonthName, // For filtering
                        year: year,
                        status: monthData.status || 'unknown',
                        reportingDate: monthDisplay,
                        amountSpent: totalSpent,
                        leadsGenerated: uniqueLeads,
                        unitSold: totalUnitSold,
                        avgDealSize: avgDealSize,
                        salesVolume: salesVolume,
                        companyRevenue: companyRevenue,
                        closerCommission: closerCommission,
                        teamLeaderCommission: teamLeaderCommission,
                        headOfSalesCommission: headOfSalesCommission,
                        externalMarketingTeam: externalMarketingTeam,
                        costPerLead: costPerLead,
                        conversionRate: conversionRate,
                        roas: roas,
                        avgClosingTimeMonths: avgClosingTimeMonths
                    });
                });
            });

            // Sort by campaign name and month
            campaignData.sort((a, b) => {
                if (a.campaignName !== b.campaignName) {
                    return a.campaignName.localeCompare(b.campaignName);
                }
                return a.monthKey.localeCompare(b.monthKey);
            });

            console.log(`Final processed monthly data:`, campaignData.length, 'entries');
        }

        function populateFilters() {
            const campaignFilter = document.getElementById('campaignFilter');
            
            // Clear existing options
            campaignFilter.innerHTML = '<option value="">All Campaigns</option>';
            
            // Predefined campaign list (from user requirements)
            const predefinedCampaigns = [
                'HT_Lead_Testimonial - new',
                'KL // CV // CBO // DE Robert Geiss Interview 14.12.23 KL_AMI_CBO_Monaco_Vermoegen_in_Sicherheit',
                'Recuiting Social Media',
                'Neue Kampagne f√ºr Leads ohne Zielgruppeninteressen KL_LG_CBO_RYM_Direct_DACHUAE',
                'KL_LG_CBO_DubaiVision_2040_DE KL_LiveWebinar_TOF_CBO_Lead_Website_20240717 KL_ABO_Spain_Lead_Website_Vermoegen_in_Sicherheit_Erstgespraech_20240522 - Copy KL_ABO_UAE_Lead_Website_Vermoegen_in_Sicherheit_Erstgespraech_20240522 - Copy',
                'KL_AMI_ABO_Spain_Vermoegen_in_Sicherheit KL_ABO_Lead_Website_Vermoegen_in_Sicherheit_Erstgespraech_20240522 KL_AMI_ABO_Dubai_Vermoegen_in_Sicherheit KL_AMI_ABO_Vermoegen_in_Sicherheit Recuiting Videograf KL_AMR_ABO_Vermoegen_in_Sicherheit Recuiting Social Media - Copy',
                'KL // CV // CBO // DE Robert Geiss Interview 22.04.24 neu HT_Lead_ABO_DIETER_BOHLEN_new KL_LG_CBO_DubaiVision_2040_DE_new2025',
                'KL_LG_CBO_Dubai √úberlebensstrategien Report 2024_DE - Copy KL_LG_CBO_Dubai_Q3_Report_DE_neu20254 KL_Lead_ABO_DIETER_BOHLEN_Augsburg',
                'Recruiting Agents UAE 2025',
                'KL_LG_CBO_Webinar_LP_23032025',
                'KL_LG_CBO_Dubai √úberlebensstrategien Report 2024_DE',
                'KL_LP_ABO_DieterBohlen_20250411',
                'KL_LP_ABO_DieterBohlen_20250419',
                'KL_LG_ABO_111_Flip_Report',
                'KL_LG_ABO_DIETER_BOHLEN',
                'KL_LP_ABO_DieterBohlen_20250511',
                'KL_LG_ABO_DiversificationChecklist KL_LG_CBO_DubaiVision_2040_DE_new2025 ‚Äì Kopie KL_LG_ABO_111_Flip_Report20250602',
                'KL_LP_ABO_DieterBohlen_20250602 KL_LG_ABO_DirectExposeAds_DubaiIslands_20250612 KL_LG_ABO_DirectExposeAds_DubaivsRAK_20250612 KL_LG_CBO_DirectExposeAds_RYM_20250609 KL_LG_CBO_DirectAds_RYM_20250609 KL_LP_ABO_Vermoegenstag_20250709',
                'KL_LP_ABO_Webinar_29072025',
                'KL_LP_ABO_InvestmentKongress2025_200825'
            ];
            
            // Get actual campaigns from data
            const actualCampaigns = [...new Set(campaignData.map(item => item.campaignName))];
            
            // Combine predefined and actual campaigns, removing duplicates
            const allPossibleCampaigns = [...new Set([...predefinedCampaigns, ...actualCampaigns])];
            
            // Sort campaigns alphabetically
            allPossibleCampaigns.sort((a, b) => a.localeCompare(b));
            
            // Populate campaign filter
            allPossibleCampaigns.forEach(campaign => {
                const option = document.createElement('option');
                option.value = campaign;
                option.textContent = campaign;
                // Mark with indicator if it has actual data
                if (actualCampaigns.includes(campaign)) {
                    option.textContent = `${campaign} ‚úì`;
                }
                campaignFilter.appendChild(option);
            });

            allCampaigns = actualCampaigns;
        }

        function populateSettingsFilters() {
            const settingsCampaignFilter = document.getElementById('settingsCampaignFilter');
            const weekFilter = document.getElementById('weekFilter');
            
            // Clear existing options
            if(settingsCampaignFilter) settingsCampaignFilter.innerHTML = '<option value="">All Campaigns</option>';
            if(weekFilter) weekFilter.innerHTML = '<option value="">All Weeks</option>';
            
            if (!settingsData || settingsData.length === 0) {
                console.log('No settings data available for filters');
                return;
            }
            
            // Predefined campaign list (same as above)
            const predefinedCampaigns = [
                'HT_Lead_Testimonial - new',
                'KL // LG // CBO // DE Robert Geiss Interview 16.04.24 HT_Lead_ABO_DIETER_BOHLEN',
                'KL_LG_CBO_Dubai √úberlebensstrategien Report 2024_DE HT_Lead_Teestimonial',
                'KL // CV // CB // AEON Creek Objektads DE Recruiting Agents 2025',
                'KL // CV // CB // RYM Objektads DE',
                'KL // CV // CBO // S√ºd-FRA Robert Geiss Interview 14.12.23',
                'HT_Lead_Testimonial KL_LG_CBO_Dubai_Q3_Report_DE_neu HT_CBO_Lead_h1_report24_20241101',
                'KL // CV // CBO // Dubai Robert Geiss Interview 14.12.23',
                'KL // LG // CBO // Dubai Q3 Report HT_ABO_Lead_Website_report24_20241101',
                'KL // CV // CBO // DE Robert Geiss Interview 14.12.23 KL_AMI_CBO_Monaco_Vermoegen_in_Sicherheit',
                'Recuiting Social Media',
                'Neue Kampagne f√ºr Leads ohne Zielgruppeninteressen KL_LG_CBO_RYM_Direct_DACHUAE',
                'KL_LG_CBO_DubaiVision_2040_DE KL_LiveWebinar_TOF_CBO_Lead_Website_20240717 KL_ABO_Spain_Lead_Website_Vermoegen_in_Sicherheit_Erstgespraech_20240522 - Copy KL_ABO_UAE_Lead_Website_Vermoegen_in_Sicherheit_Erstgespraech_20240522 - Copy',
                'KL_AMI_ABO_Spain_Vermoegen_in_Sicherheit KL_ABO_Lead_Website_Vermoegen_in_Sicherheit_Erstgespraech_20240522 KL_AMI_ABO_Dubai_Vermoegen_in_Sicherheit KL_AMI_ABO_Vermoegen_in_Sicherheit Recuiting Videograf KL_AMR_ABO_Vermoegen_in_Sicherheit Recuiting Social Media - Copy',
                'KL // CV // CBO // DE Robert Geiss Interview 22.04.24 neu HT_Lead_ABO_DIETER_BOHLEN_new KL_LG_CBO_DubaiVision_2040_DE_new2025',
                'KL_LG_CBO_Dubai √úberlebensstrategien Report 2024_DE - Copy KL_LG_CBO_Dubai_Q3_Report_DE_neu20254 KL_Lead_ABO_DIETER_BOHLEN_Augsburg',
                'Recruiting Agents UAE 2025',
                'KL_LG_CBO_Webinar_LP_23032025',
                'KL_LG_CBO_Dubai √úberlebensstrategien Report 2024_DE',
                'KL_LP_ABO_DieterBohlen_20250411',
                'KL_LP_ABO_DieterBohlen_20250419',
                'KL_LG_ABO_111_Flip_Report',
                'KL_LG_ABO_DIETER_BOHLEN',
                'KL_LP_ABO_DieterBohlen_20250511',
                'KL_LG_ABO_DiversificationChecklist KL_LG_CBO_DubaiVision_2040_DE_new2025 ‚Äì Kopie KL_LG_ABO_111_Flip_Report20250602',
                'KL_LP_ABO_DieterBohlen_20250602 KL_LG_ABO_DirectExposeAds_DubaiIslands_20250612 KL_LG_ABO_DirectExposeAds_DubaivsRAK_20250612 KL_LG_CBO_DirectExposeAds_RYM_20250609 KL_LG_CBO_DirectAds_RYM_20250609 KL_LP_ABO_Vermoegenstag_20250709',
                'KL_LP_ABO_Webinar_29072025',
                'KL_LP_ABO_InvestmentKongress2025_200825'
            ];
            
            // Get actual campaigns and weeks from settings data
            const settingsCampaigns = [...new Set(settingsData.map(item => item.campaignName))];
            allWeeks = [...new Set(settingsData.map(item => item.weekNo))];
            
            // Combine predefined and actual campaigns, removing duplicates
            const allPossibleCampaigns = [...new Set([...predefinedCampaigns, ...settingsCampaigns])];
            
            // Sort campaigns alphabetically
            allPossibleCampaigns.sort((a, b) => a.localeCompare(b));
            
            // Populate settings campaign filter
            if(settingsCampaignFilter) {
                allPossibleCampaigns.forEach(campaign => {
                    const option = document.createElement('option');
                    option.value = campaign;
                    option.textContent = campaign;
                    // Mark with indicator if it has actual data
                    if (settingsCampaigns.includes(campaign)) {
                        option.textContent = `${campaign} ‚úì`;
                    }
                    settingsCampaignFilter.appendChild(option);
                });
            }


            // Populate week filter (sort by year and week)
            if(weekFilter) {
                allWeeks.sort((a, b) => {
                    const aMatch = a.match(/W(\d+)/);
                    const bMatch = b.match(/W(\d+)/);
                    if (!aMatch || !bMatch) return 0;
                    return parseInt(bMatch[1]) - parseInt(aMatch[1]); // Latest week first
                }).forEach(week => {
                    const option = document.createElement('option');
                    option.value = week;
                    option.textContent = week;
                    weekFilter.appendChild(option);
                });
            }
        }

        function formatCurrency(value) {
            if (!value || value === 0) return '0';
            return value.toLocaleString('en-AE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
        
        function formatCurrencyWithAED(value) {
            if (!value || value === 0) return 'AED 0';
            return 'AED ' + value.toLocaleString('en-AE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatNumber(value) {
            if (!value || value === 0) return '0';
            return value.toLocaleString();
        }

        function renderTable() {
            const tbody = document.getElementById('campaignTableBody');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="no-data">No data matches the selected filters</td></tr>';
                return;
            }

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'campaign-row';
                
                const roasClass = row.roas >= 1 ? 'roas-positive' : 'roas-negative';
                const totalCommissions = (row.closerCommission || 0) + (row.teamLeaderCommission || 0) + (row.headOfSalesCommission || 0) + (row.externalMarketingTeam || 0);
                const netRevenue = row.companyRevenue - row.amountSpent - totalCommissions; // Net = Company Revenue - Ad Spend - All Commissions

                tr.innerHTML = `
                    <td class="month-cell">${row.month}</td>
                    <td class="currency">${formatCurrency(row.amountSpent)}</td>
                    <td>${formatNumber(row.leadsGenerated)}</td>
                    <td class="currency">${formatCurrency(row.costPerLead)}</td>
                    <td>${formatNumber(row.unitSold)}</td>
                    <td class="currency">${formatCurrency(row.avgDealSize)}</td>
                    <td class="currency">${formatCurrency(row.salesVolume)}</td>
                    <td class="currency">${formatCurrency(row.companyRevenue)}</td>
                    <td><span class="${roasClass}">${row.roas.toFixed(2)}</span></td>
                    <td>${row.avgClosingTimeMonths.toFixed(1)}</td>
                    <td class="currency">${formatCurrency(row.closerCommission || 0)}</td>
                    <td class="currency">${formatCurrency(row.teamLeaderCommission || 0)}</td>
                    <td class="currency">${formatCurrency(row.headOfSalesCommission || 0)}</td>
                    <td class="currency">${formatCurrency(row.externalMarketingTeam || 0)}</td>
                    <td class="currency ${netRevenue < 0 ? 'negative' : ''}">${formatCurrency(netRevenue)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSettingsTable() {
            const tbody = document.getElementById('settingsTableBody');
            tbody.innerHTML = '';

            if (filteredSettingsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No settings data matches the selected filters</td></tr>';
                return;
            }

            filteredSettingsData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'settings-row';
                
                tr.innerHTML = `
                    <td class="campaign-cell" style="text-align: left; padding-left: 8px; font-weight: 600;">${row.campaignName}</td>
                    <td class="week-cell">${row.weekNo}</td>
                    <td class="week-cell">${row.year}</td>
                    <td>${formatNumber(row.noOfLeads)}</td>
                    <td class="currency">${formatCurrency(row.adsSpent)}</td>
                    <td class="currency">${formatCurrency(row.cpl)}</td>
                    <td>${formatNumber(row.noOfSettings)}</td>
                    <td class="currency">${formatCurrency(row.cps)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateSummaryMetrics() {
            const totalCampaigns = [...new Set(filteredData.map(row => row.campaignName))].length;
            const totalAdSpent = filteredData.reduce((sum, row) => sum + row.amountSpent, 0);
            const totalLeads = filteredData.reduce((sum, row) => sum + row.leadsGenerated, 0);
            const totalUnitSold = filteredData.reduce((sum, row) => sum + row.unitSold, 0);
            const totalSalesVolume = filteredData.reduce((sum, row) => sum + (row.salesVolume || 0), 0);
            const totalCompanyRevenue = filteredData.reduce((sum, row) => sum + (row.companyRevenue || 0), 0);
            const avgROAS = filteredData.length > 0 ? 
                (filteredData.reduce((sum, row) => sum + row.roas, 0) / filteredData.length) : 0;

            document.getElementById('totalCampaigns').textContent = formatNumber(totalCampaigns);
            document.getElementById('totalAdSpent').textContent = formatCurrencyWithAED(totalAdSpent);
            document.getElementById('totalLeads').textContent = formatNumber(totalLeads);
            document.getElementById('totalUnitSold').textContent = formatNumber(totalUnitSold);
            document.getElementById('totalRevenue').textContent = formatCurrencyWithAED(totalCompanyRevenue);
            document.getElementById('avgROAS').textContent = avgROAS.toFixed(2);
            
            // Update sales volume if element exists
            const salesVolumeElement = document.getElementById('totalSalesVolume');
            if (salesVolumeElement) {
                salesVolumeElement.textContent = formatCurrencyWithAED(totalSalesVolume);
            }
        }

        function updateSettingsSummaryMetrics() {
            const totalSettingsLeads = filteredSettingsData.reduce((sum, row) => sum + row.noOfLeads, 0);
            const totalSettingsSpent = filteredSettingsData.reduce((sum, row) => sum + row.adsSpent, 0);
            const totalSettingsCount = filteredSettingsData.reduce((sum, row) => sum + row.noOfSettings, 0);
            const avgCPL = totalSettingsLeads > 0 ? (totalSettingsSpent / totalSettingsLeads) : 0;
            const avgCPS = totalSettingsCount > 0 ? (totalSettingsSpent / totalSettingsCount) : 0;

            document.getElementById('totalSettingsLeads').textContent = formatNumber(totalSettingsLeads);
            document.getElementById('totalSettingsSpent').textContent = formatCurrencyWithAED(totalSettingsSpent);
            document.getElementById('totalSettings').textContent = formatNumber(totalSettingsCount);
            document.getElementById('avgCPL').textContent = formatCurrencyWithAED(avgCPL);
            document.getElementById('avgCPS').textContent = formatCurrencyWithAED(avgCPS);
        }

        function applyFilters() {
            if (!isConnected) return;

            const campaignFilter = document.getElementById('campaignFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter2').value;

            // Filter the campaign data
            let baseFilteredData = campaignData.filter(row => {
                const matchesCampaign = !campaignFilter || row.campaignName === campaignFilter;
                const matchesStatus = !statusFilter || row.status === statusFilter;
                const matchesMonth = !monthFilter || row.fullMonthName === monthFilter;
                const matchesYear = !yearFilter || row.year === yearFilter;
                
                return matchesCampaign && matchesStatus && matchesMonth && matchesYear;
            });

            // If "All Campaigns" is selected, aggregate data by month
            if (!campaignFilter) {
                const monthlyAggregated = {};
                
                baseFilteredData.forEach(row => {
                    const monthKey = row.month;
                    
                    if (!monthlyAggregated[monthKey]) {
                        monthlyAggregated[monthKey] = {
                            month: monthKey,
                            monthKey: row.monthKey,
                            fullMonthName: row.fullMonthName,
                            year: row.year,
                            campaignName: 'All Campaigns',
                            status: 'mixed',
                            amountSpent: 0,
                            leadsGenerated: 0,
                            unitSold: 0,
                            salesVolume: 0,
                            companyRevenue: 0,
                            closerCommission: 0,
                            teamLeaderCommission: 0,
                            headOfSalesCommission: 0,
                            externalMarketingTeam: 79000, // Fixed amount per month
                            totalClosingTimeDays: 0,
                            campaigns: new Set()
                        };
                    }
                    
                    monthlyAggregated[monthKey].amountSpent += row.amountSpent;
                    monthlyAggregated[monthKey].leadsGenerated += row.leadsGenerated;
                    monthlyAggregated[monthKey].unitSold += row.unitSold;
                    monthlyAggregated[monthKey].salesVolume += row.salesVolume;
                    monthlyAggregated[monthKey].companyRevenue += row.companyRevenue;
                    monthlyAggregated[monthKey].closerCommission += row.closerCommission;
                    monthlyAggregated[monthKey].teamLeaderCommission += row.teamLeaderCommission;
                    monthlyAggregated[monthKey].headOfSalesCommission += row.headOfSalesCommission;
                    monthlyAggregated[monthKey].totalClosingTimeDays += (row.avgClosingTimeMonths * 30.44 * row.unitSold); // Weight by customers
                    monthlyAggregated[monthKey].campaigns.add(row.campaignName);
                });

                // Calculate derived metrics for aggregated data
                filteredData = Object.values(monthlyAggregated).map(monthData => {
                    const costPerLead = monthData.leadsGenerated > 0 ? (monthData.amountSpent / monthData.leadsGenerated) : 0;
                    const conversionRate = monthData.leadsGenerated > 0 ? (monthData.unitSold / monthData.leadsGenerated * 100) : 0;
                    const roas = monthData.amountSpent > 0 ? (monthData.companyRevenue / monthData.amountSpent) : 0;
                    const avgDealSize = monthData.unitSold > 0 ? (monthData.salesVolume / monthData.unitSold) : 0;
                    const avgClosingTimeMonths = monthData.unitSold > 0 ? 
                        (monthData.totalClosingTimeDays / monthData.unitSold / 30.44) : 0; // Weighted average
                    
                    return {
                        ...monthData,
                        costPerLead: costPerLead,
                        conversionRate: conversionRate,
                        roas: roas,
                        avgDealSize: avgDealSize,
                        avgClosingTimeMonths: avgClosingTimeMonths,
                        reportingDate: monthData.month
                    };
                });

                // Sort by month
                filteredData.sort((a, b) => a.monthKey.localeCompare(b.monthKey));
                
            } else {
                // If specific campaign selected, show individual campaign monthly data
                filteredData = baseFilteredData;
            }

            renderTable();
            updateSummaryMetrics();
            renderCharts(); // Add charts rendering
        }

        function applySettingsFilters() {
            if (!isConnected || settingsData.length === 0) {
                document.getElementById('settingsTableBody').innerHTML = '<tr><td colspan="8" class="no-data">No settings data available</td></tr>';
                return;
            }
            
            // The main filters now control this tab as well
            const campaignFilter = document.getElementById('campaignFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const yearFilter = document.getElementById('yearFilter2').value;

            // Filter the settings data based on the main filters
            let baseFilteredData = settingsData.filter(row => {
                const matchesCampaign = !campaignFilter || row.campaignName === campaignFilter;
                const matchesStatus = !statusFilter || row.status === statusFilter;
                const matchesYear = !yearFilter || row.year == parseInt(yearFilter);
                
                return matchesCampaign && matchesStatus && matchesYear;
            });

            // If "All Campaigns" is selected, aggregate data by week
            if (!campaignFilter) {
                const weeklyAggregated = {};
                
                baseFilteredData.forEach(row => {
                    const weekKey = `${row.weekNo}-${row.year}`;
                    
                    if (!weeklyAggregated[weekKey]) {
                        weeklyAggregated[weekKey] = {
                            campaignName: 'All Campaigns',
                            weekNo: row.weekNo,
                            year: row.year,
                            weekKey: weekKey,
                            status: 'mixed',
                            noOfLeads: 0,
                            adsSpent: 0,
                            noOfSettings: 0,
                            campaigns: new Set()
                        };
                    }
                    
                    weeklyAggregated[weekKey].noOfLeads += row.noOfLeads;
                    weeklyAggregated[weekKey].adsSpent += row.adsSpent;
                    weeklyAggregated[weekKey].noOfSettings += row.noOfSettings;
                    weeklyAggregated[weekKey].campaigns.add(row.campaignName);
                });

                // Calculate derived metrics for aggregated data
                filteredSettingsData = Object.values(weeklyAggregated).map(weekData => {
                    const cpl = weekData.noOfLeads > 0 ? (weekData.adsSpent / weekData.noOfLeads) : 0;
                    const cps = weekData.noOfSettings > 0 ? (weekData.adsSpent / weekData.noOfSettings) : 0;
                    
                    return {
                        ...weekData,
                        cpl: cpl,
                        cps: cps
                    };
                });

                // Sort by year and week (latest first)
                filteredSettingsData.sort((a, b) => {
                    if (a.year !== b.year) return b.year - a.year;
                    const aWeek = parseInt(a.weekNo.replace('W', ''));
                    const bWeek = parseInt(b.weekNo.replace('W', ''));
                    return bWeek - aWeek;
                });
                
            } else {
                // If specific campaign selected, show individual campaign weekly data
                filteredSettingsData = baseFilteredData;
            }

            renderSettingsTable();
            updateSettingsSummaryMetrics();
        }

        // Calculator Functions
        function calculateProjections() {
            // Get input values
            const totalBudget = parseFloat(document.getElementById('totalBudget')?.value) || 0;
            const impressions = parseFloat(document.getElementById('impressions')?.value) || 0;
            const ctr = parseFloat(document.getElementById('ctr')?.value) / 100 || 0;
            const leadConversionRate = parseFloat(document.getElementById('leadConversionRate')?.value) / 100 || 0;
            const bookingRate = parseFloat(document.getElementById('bookingRate')?.value) / 100 || 0;
            const showRate = parseFloat(document.getElementById('showRate')?.value) / 100 || 0;
            const closeRate = parseFloat(document.getElementById('closeRate')?.value) / 100 || 0;
            const avgDealSize = parseFloat(document.getElementById('avgDealSize')?.value) || 0;
            const commissionRate = parseFloat(document.getElementById('commissionRate')?.value) / 100 || 0;
            const collectionRate = parseFloat(document.getElementById('collectionRate')?.value) / 100 || 0;
            const setterCommissionRate = parseFloat(document.getElementById('setterCommissionRate')?.value) / 100 || 0;
            const closerCommissionRate = parseFloat(document.getElementById('closerCommissionRate')?.value) / 100 || 0;

            // Calculate metrics following the provided formulas
            const totalClicks = impressions * ctr;
            const costPerClick = totalClicks > 0 ? totalBudget / totalClicks : 0;
            const totalLeads = totalClicks * leadConversionRate;
            const costPerLead = totalLeads > 0 ? totalBudget / totalLeads : 0;
            const totalBookedCalls = totalLeads * bookingRate;
            const costPerBookedCall = totalBookedCalls > 0 ? totalBudget / totalBookedCalls : 0;
            const totalTakenCalls = totalBookedCalls * showRate;
            const costPerTakenCall = totalTakenCalls > 0 ? totalBudget / totalTakenCalls : 0;
            const totalUnitsClosed = totalTakenCalls * closeRate;
            const totalRevenuePerClose = avgDealSize * commissionRate;
            const totalRevenueContracted = totalUnitsClosed * avgDealSize;
            const totalRevenueCollected = totalRevenueContracted * collectionRate;
            const costPerAcquisition = totalUnitsClosed > 0 ? totalBudget / totalUnitsClosed : 0;
            const revenueROAS = totalBudget > 0 ? totalRevenueCollected / totalBudget : 0;
            const settersNeeded = Math.ceil(totalBookedCalls / 720);
            const setterCommission = (totalRevenueCollected * setterCommissionRate);
            const closersNeeded = Math.ceil(totalTakenCalls / 22 / 6);
            const closerCommission = (totalRevenueCollected * closerCommissionRate);
            const netProfit = totalRevenueCollected - totalBudget - setterCommission - closerCommission;

            // Update display
            document.getElementById('costPerClick').textContent = 'AED ' + formatCurrency(costPerClick);
            document.getElementById('costPerLead').textContent = 'AED ' + formatCurrency(costPerLead);
            document.getElementById('totalLeadsCalc').textContent = Math.round(totalLeads);
            document.getElementById('totalBookedCalls').textContent = Math.round(totalBookedCalls);
            document.getElementById('costPerBookedCall').textContent = 'AED ' + formatCurrency(costPerBookedCall);
            document.getElementById('totalTakenCalls').textContent = Math.round(totalTakenCalls);
            document.getElementById('costPerTakenCall').textContent = 'AED ' + formatCurrency(costPerTakenCall);
            document.getElementById('totalUnitsClosed').textContent = Math.round(totalUnitsClosed);
            document.getElementById('totalRevenuePerClose').textContent = 'AED ' + formatCurrency(totalRevenuePerClose);
            document.getElementById('totalRevenueContracted').textContent = 'AED ' + formatCurrency(totalRevenueContracted);
            document.getElementById('totalRevenueCollected').textContent = 'AED ' + formatCurrency(totalRevenueCollected);
            document.getElementById('costPerAcquisition').textContent = 'AED ' + formatCurrency(costPerAcquisition);
            document.getElementById('revenueROAS').textContent = revenueROAS.toFixed(2) + 'x';
            document.getElementById('settersNeeded').textContent = settersNeeded;
            document.getElementById('setterCommission').textContent = 'AED ' + formatCurrency(setterCommission);
            document.getElementById('closersNeeded').textContent = closersNeeded;
            document.getElementById('closerCommission').textContent = 'AED ' + formatCurrency(closerCommission);
            document.getElementById('netProfit').textContent = 'AED ' + formatCurrency(netProfit);

            // Render funnel chart
            renderCalculatorChart({
                impressions,
                clicks: totalClicks,
                leads: totalLeads,
                bookedCalls: totalBookedCalls,
                takenCalls: totalTakenCalls,
                closedDeals: totalUnitsClosed,
                revenue: totalRevenueCollected
            });
        }

        // Chart Functions
        let spendRevenueChart, roasChart, topCampaignsChart, calculatorChart, yearlyROASChart;

        function calculateYearlyInsights() {
            // Always use full campaign data regardless of filters
            const yearlyData = {};
            
            campaignData.forEach(row => {
                const year = parseInt(row.year);
                
                if (!yearlyData[year]) {
                    yearlyData[year] = {
                        year: year,
                        totalAdSpend: 0,
                        totalRevenue: 0
                    };
                }
                
                yearlyData[year].totalAdSpend += row.amountSpent;
                yearlyData[year].totalRevenue += row.companyRevenue;
            });
            
            // Calculate ROAS for each year and prepare data
            const yearlyInsights = Object.values(yearlyData).map(year => ({
                year: year.year,
                totalAdSpend: year.totalAdSpend,
                totalRevenue: year.totalRevenue,
                roas: year.totalAdSpend > 0 ? (year.totalRevenue / year.totalAdSpend) : 0
            })).sort((a, b) => a.year - b.year);
            
            return yearlyInsights;
        }

        function renderYearlyInsights() {
            const yearlyInsights = calculateYearlyInsights();
            const tbody = document.getElementById('yearlyInsightsTableBody');
            tbody.innerHTML = '';
            
            // Calculate totals for weighted average
            let totalAdSpend = 0;
            let totalRevenue = 0;
            
            // Render individual year rows
            yearlyInsights.forEach(year => {
                totalAdSpend += year.totalAdSpend;
                totalRevenue += year.totalRevenue;
                
                const tr = document.createElement('tr');
                const roasClass = year.roas >= 1 ? 'roas-positive' : 'roas-negative';
                
                tr.innerHTML = `
                    <td class="year-cell">${year.year}</td>
                    <td class="currency-cell">AED ${formatCurrency(year.totalAdSpend)}</td>
                    <td class="currency-cell">AED ${formatCurrency(year.totalRevenue)}</td>
                    <td class="roas-cell ${roasClass}">${year.roas.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Add totals row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            const totalROAS = totalAdSpend > 0 ? (totalRevenue / totalAdSpend) : 0;
            const totalROASClass = totalROAS >= 1 ? 'roas-positive' : 'roas-negative';
            
            totalRow.innerHTML = `
                <td class="year-cell">Total</td>
                <td class="currency-cell">AED ${formatCurrency(totalAdSpend)}</td>
                <td class="currency-cell">AED ${formatCurrency(totalRevenue)}</td>
                <td class="roas-cell ${totalROASClass}">${totalROAS.toFixed(2)}</td>
            `;
            tbody.appendChild(totalRow);
            
            // Update weighted average ROAS
            document.getElementById('weightedAvgROAS').textContent = totalROAS.toFixed(2);
            document.getElementById('weightedAvgROAS').className = totalROAS >= 1 ? 'roas-positive' : 'roas-negative';
            
            // Render yearly ROAS chart
            renderYearlyROASChart(yearlyInsights);
        }

        function renderYearlyROASChart(yearlyInsights) {
            const ctx = document.getElementById('yearlyROASChart').getContext('2d');
            
            if (yearlyROASChart) {
                yearlyROASChart.destroy();
            }

            yearlyROASChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: yearlyInsights.map(d => d.year.toString()),
                    datasets: [{
                        label: 'ROAS Trend',
                        data: yearlyInsights.map(d => d.roas),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: yearlyInsights.map(d => d.roas >= 1 ? '#27ae60' : '#e74c3c'),
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.8,
                    layout: {
                        padding: {
                            top: 10,
                            right: 10,
                            bottom: 10,
                            left: 10
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(...yearlyInsights.map(d => d.roas)) * 1.2,
                            title: {
                                display: true,
                                text: 'ROAS',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + 'x';
                                },
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)',
                                drawBorder: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)',
                                drawBorder: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#3498db',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    return `Year ${context[0].label}`;
                                },
                                label: function(context) {
                                    return `ROAS: ${context.parsed.y.toFixed(2)}x`;
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            borderCapStyle: 'round',
                            borderJoinStyle: 'round'
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function renderCharts() {
            if (!isConnected || filteredData.length === 0) return;

            // Show insights and charts sections
            document.getElementById('insightsSection').style.display = 'block';
            document.getElementById('chartsSection').style.display = 'block';
            
            renderYearlyInsights();
            renderSpendRevenueChart();
            renderROASChart();
            renderTopCampaignsChart();
        }

        function renderSpendRevenueChart() {
            const ctx = document.getElementById('spendRevenueChart').getContext('2d');
            
            if (spendRevenueChart) {
                spendRevenueChart.destroy();
            }

            // Get current campaign filter to determine label format
            const campaignFilter = document.getElementById('campaignFilter').value;
            
            // Prepare chart data based on current filters
            const chartData = filteredData.map(row => ({
                // If specific campaign selected, show only month-year, otherwise show campaign name + month
                label: campaignFilter && campaignFilter !== '' ? row.month : 
                    (row.campaignName === 'All Campaigns' ? row.month : `${row.campaignName} - ${row.month}`),
                spend: row.amountSpent,
                revenue: row.companyRevenue
            }));

            spendRevenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.label),
                    datasets: [{
                        label: 'Ad Spend',
                        data: chartData.map(d => d.spend),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Company Revenue',
                        data: chartData.map(d => d.revenue),
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'AED ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function renderROASChart() {
            const ctx = document.getElementById('roasChart').getContext('2d');
            
            if (roasChart) {
                roasChart.destroy();
            }

            // Get current campaign filter to determine label format
            const campaignFilter = document.getElementById('campaignFilter').value;
            
            // Prepare chart data based on current filters
            const chartData = filteredData.map(row => ({
                // If specific campaign selected, show only month-year, otherwise show campaign name + month
                label: campaignFilter && campaignFilter !== '' ? row.month : 
                    (row.campaignName === 'All Campaigns' ? row.month : `${row.campaignName} - ${row.month}`),
                roas: row.roas
            }));

            roasChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.label),
                    datasets: [{
                        label: 'ROAS',
                        data: chartData.map(d => d.roas),
                        backgroundColor: chartData.map(d => d.roas >= 1 ? '#27ae60' : '#e74c3c'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + 'x';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }

        function renderTopCampaignsChart() {
            const ctx = document.getElementById('topCampaignsChart').getContext('2d');
            
            if (topCampaignsChart) {
                topCampaignsChart.destroy();
            }

            // Always show top campaigns by ad spend, regardless of filters
            // Aggregate data based on current filters but show campaign names
            const campaignTotals = {};
            
            // Get the underlying campaign data (before "All Campaigns" aggregation)
            let baseData = campaignData;
            
            // Apply the same filters as the main view, but to individual campaign data
            const campaignFilter = document.getElementById('campaignFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const yearFilter = document.getElementById('yearFilter2').value;

            // Filter the base campaign data
            baseData = campaignData.filter(row => {
                const matchesStatus = !statusFilter || row.status === statusFilter;
                const matchesMonth = !monthFilter || row.fullMonthName === monthFilter;
                const matchesYear = !yearFilter || row.year === yearFilter;
                
                return matchesStatus && matchesMonth && matchesYear;
            });
            
            // Aggregate by campaign (excluding any "All Campaigns" entries)
            baseData.forEach(row => {
                if (row.campaignName === 'All Campaigns') return;
                
                if (!campaignTotals[row.campaignName]) {
                    campaignTotals[row.campaignName] = 0;
                }
                campaignTotals[row.campaignName] += row.amountSpent;
            });
            
            // Convert to array and sort by spend (highest to lowest)
            const chartData = Object.entries(campaignTotals)
                .map(([campaign, spend]) => ({ campaign, spend }))
                .sort((a, b) => b.spend - a.spend)
                .slice(0, 10); // Top 10 campaigns

            topCampaignsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.campaign),
                    datasets: [{
                        label: 'Ad Spend',
                        data: chartData.map(d => d.spend),
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'AED ' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function renderCalculatorChart(data) {
            const ctx = document.getElementById('calculatorFunnelChart').getContext('2d');
            
            if (calculatorChart) {
                calculatorChart.destroy();
            }

            const funnelData = [
                { label: 'Impressions', value: data.impressions, color: '#3498db' },
                { label: 'Clicks', value: data.clicks, color: '#e67e22' },
                { label: 'Leads', value: data.leads, color: '#9b59b6' },
                { label: 'Booked Calls', value: data.bookedCalls, color: '#e74c3c' },
                { label: 'Taken Calls', value: data.takenCalls, color: '#f39c12' },
                { label: 'Closed Deals', value: data.closedDeals, color: '#27ae60' }
            ];

            calculatorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: funnelData.map(d => d.label),
                    datasets: [{
                        label: 'Campaign Funnel',
                        data: funnelData.map(d => Math.round(d.value)),
                        backgroundColor: funnelData.map(d => d.color),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.x.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        async function refreshData() {
            if (!isConnected || !webAppUrl) return;

            const button = document.getElementById('refreshBtn');
            button.innerHTML = 'üîÑ Refreshing...';
            button.disabled = true;
            updateSyncStatus('Refreshing data...', false);

            try {
                const sheetsData = await fetchDataFromAppsScript(webAppUrl);
                processSheetData(sheetsData);
                settingsData = processSettingsData(sheetsData.settings, sheetsData.leads, sheetsData.meta);
                populateFilters();
                populateSettingsFilters();
                applyFilters();
                applySettingsFilters();
                updateSyncStatus('‚úÖ Data refreshed', true);
                console.log('Data refreshed successfully');
            } catch (error) {
                console.error('Refresh failed:', error);
                updateSyncStatus('‚ùå Refresh failed', false);
                showStatus(`Refresh failed: ${error.message}`, 'error');
            }

            button.innerHTML = 'üîÑ Refresh Data';
            button.disabled = false;
        }

        function startAutoRefresh() {
            // Auto-refresh every 10 minutes
            setInterval(async () => {
                if (isConnected) {
                    console.log('Auto-refreshing data...');
                    try {
                        await refreshData();
                    } catch (error) {
                        console.error('Auto-refresh failed:', error);
                    }
                }
            }, 600000); // 10 minutes
        }

        function showSettings() {
            const setupSection = document.getElementById('setupSection');
            if (setupSection.classList.contains('show')) {
                setupSection.classList.remove('show');
                document.getElementById('settingsBtn').textContent = '‚öôÔ∏è Settings';
            } else {
                setupSection.classList.add('show');
                document.getElementById('settingsBtn').textContent = '‚ùå Hide Settings';
            }
        }

        // Event listeners
        document.getElementById('campaignFilter').addEventListener('change', () => {
            applyFilters();
            applySettingsFilters(); // Also apply to settings tab
        });
        document.getElementById('statusFilter').addEventListener('change', () => {
            applyFilters();
            applySettingsFilters(); // Also apply to settings tab
        });
        document.getElementById('monthFilter').addEventListener('change', applyFilters);
        document.getElementById('yearFilter2').addEventListener('change', () => {
            applyFilters();
            applySettingsFilters(); // Also apply to settings tab
        });

        // Load saved URL and auto-connect if available
        window.addEventListener('load', () => {
            // Use the predefined URL or saved URL
            const savedUrl = localStorage.getItem('webAppUrl');
            const urlToUse = savedUrl || DEFAULT_WEB_APP_URL;
            
            document.getElementById('webAppUrl').value = urlToUse;
            
            // Hide setup section initially for clean CMO experience
            document.getElementById('setupSection').classList.remove('show');
            
            // Auto-connect for CMO
            setTimeout(() => {
                console.log('Auto-loading dashboard for CMO...');
                updateSyncStatus('üîÑ Connecting to Google Sheets...', false);
                
                // Set the URL and connect
                webAppUrl = urlToUse;
                fetchDataFromAppsScript(urlToUse)
                    .then(sheetsData => {
                        updateSyncStatus('üìä Processing campaign data...', false);
                        processSheetData(sheetsData);
                        
                        updateSyncStatus('‚öôÔ∏è Processing settings data...', false);
                        
                        // Process settings data with Meta sheet
                        settingsData = processSettingsData(sheetsData.settings, sheetsData.leads, sheetsData.meta);
                        
                        isConnected = true;
                        
                        // Show table and metrics
                        document.getElementById('campaignTable').style.display = 'table';
                        document.getElementById('summaryMetrics').style.display = 'grid';
                        document.getElementById('insightsSection').style.display = 'block';
                        document.getElementById('settingsSummaryMetrics').style.display = 'grid';
                        document.getElementById('loadingMessage').style.display = 'none';
                        
                        updateSyncStatus('‚úÖ Dashboard ready - Auto-refresh enabled', true);
                        populateFilters();
                        populateSettingsFilters();
                        applyFilters();
                        applySettingsFilters();
                        localStorage.setItem('webAppUrl', urlToUse);
                        startAutoRefresh();
                        
                        console.log('Dashboard loaded successfully for CMO');
                    })
                    .catch(error => {
                        console.error('Auto-load failed:', error);
                        updateSyncStatus('‚öôÔ∏è Setup required - Click Settings', false);
                        document.getElementById('setupSection').classList.add('show');
                        document.getElementById('loadingMessage').innerHTML = `
                            <div style="color: #e74c3c; text-align: center; padding: 40px;">
                                ‚öôÔ∏è Dashboard needs setup. Please click "Settings" above to configure.<br>
                                <small style="color: #6c757d; margin-top: 10px; display: block;">Error: ${error.message}</small>
                            </div>
                        `;
                    });
            }, 1500);
        });
    </script>
</body>
</html> 